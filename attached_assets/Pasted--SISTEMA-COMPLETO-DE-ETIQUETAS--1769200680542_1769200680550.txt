====================================================================
SISTEMA COMPLETO DE ETIQUETAS ‚Äì BALAN√áA + PLATAFORMA WEB + APP WINDOWS
MODELO BASEADO EM ETIQUETA REAL DE SUPERMERCADO
====================================================================

================================================
1. VIS√ÉO GERAL DO SISTEMA
================================================

Este sistema integra:

- Plataforma Web (Replit / Vercel)
- App Local Windows (execut√°vel sem instala√ß√£o)
- Balan√ßa (protocolo serial / USB / TCP)
- Impressora t√©rmica (texto, imagem, c√≥digo de barras)
- Usu√°rio dono: SkelleTu (acesso exclusivo)

Objetivo:
Gerar etiquetas AUTOMATICAMENTE, com:
- Peso vindo da balan√ßa
- C√°lculos autom√°ticos (pre√ßo, validade, nutri√ß√£o)
- Layout fiel ao padr√£o de mercado
- Impress√£o perfeita (texto + linhas + c√≥digo de barras)

================================================
2. CONTROLE DE ACESSO (MENU EXCLUSIVO)
================================================

Ap√≥s login:
- O backend valida o usu√°rio
- Se usu√°rio.role === "OWNER" e username === "SkelleTu"
- O menu lateral exibe uma nova sess√£o:

üìÅ "Sistema de Etiquetas (Avan√ßado)"

Somente este usu√°rio v√™:
- Status da plataforma online
- Status do App Windows
- Status da balan√ßa
- Status da impressora
- Logs em tempo real
- Editor visual
- Monitor de impress√£o

================================================
3. PAINEL DE CONTROLE (DASHBOARD)
================================================

O painel mostra EM TEMPO REAL:

[STATUS]
- Plataforma Web: ONLINE / OFFLINE
- App Windows: CONECTADO / DESCONECTADO
- Balan√ßa: OK / SEM LEITURA
- Impressora: PRONTA / ERRO / SEM PAPEL

[FILA]
- Etiquetas aguardando
- Etiquetas impressas
- Erros de impress√£o

[EVENTOS]
- Peso recebido
- C√°lculo executado
- Etiqueta gerada
- Impress√£o conclu√≠da

Tudo via WebSocket.

================================================
4. FLUXO COMPLETO DE FUNCIONAMENTO
================================================

1) Produto √© selecionado
2) Balan√ßa envia o peso (ex: 0.474 kg)
3) Sistema calcula:
   - Pre√ßo total
   - Dados nutricionais proporcionais
4) Sistema gera estrutura da etiqueta
5) Estrutura vai para o App Windows
6) App renderiza layout
7) Impressora imprime

================================================
5. MODELO L√ìGICO DA ETIQUETA (DADOS)
================================================

Produto:
- Nome: CATARINA BANANA
- Pre√ßo por Kg: 35.90
- TARA: 0.040 kg
- Peso L√≠quido: 0.474 kg

C√°lculo:
Peso l√≠quido = peso bruto - tara
Total = peso l√≠quido √ó pre√ßo por kg

Ex:
0.474 √ó 35.90 = 17.02

================================================
6. C√ÅLCULO NUTRICIONAL PROPORCIONAL
================================================

Base nutricional (por 60g):
- Energia: 209 kcal
- Carboidratos: 39 g
- Prote√≠nas: 4.6 g
- Gorduras Totais: 3.8 g
- S√≥dio: 201 mg

Peso real:
0.474 kg = 474 g

Fator:
474 / 60 = 7.9

Ex:
Energia real = 209 √ó 7.9 ‚âà 1651 kcal

================================================
7. BACKEND WEB (REPLIT ‚Äì NODE.JS)
================================================

server.js
---------
const express = require("express");
const http = require("http");
const WebSocket = require("ws");

const app = express();
app.use(express.json());

const server = http.createServer(app);
const wss = new WebSocket.Server({ server });

let windowsClient = null;

wss.on("connection", ws => {
  ws.on("message", msg => {
    const data = JSON.parse(msg);
    if (data.type === "WINDOWS_HELLO") {
      windowsClient = ws;
    }
  });
});

app.post("/print", (req, res) => {
  if (!windowsClient) {
    return res.status(500).json({ error: "APP WINDOWS OFFLINE" });
  }

  windowsClient.send(JSON.stringify({
    type: "PRINT_LABEL",
    payload: req.body
  }));

  res.json({ status: "ENVIADO" });
});

server.listen(3000);

================================================
8. FORMATO UNIVERSAL DA ETIQUETA (JSON)
================================================

{
  "produto": "CATARINA BANANA",
  "peso": 0.474,
  "tara": 0.040,
  "precoKg": 35.90,
  "total": 17.02,
  "datas": {
    "fabricacao": "20/01/26",
    "validade": "23/01/26"
  },
  "barcode": "20378000170282301260",
  "nutricao": {
    "base": 60,
    "energia": 209,
    "carbo": 39,
    "proteina": 4.6,
    "gordura": 3.8,
    "sodio": 201
  }
}

================================================
9. APP WINDOWS (NODE.JS ‚Äì SEM INSTALA√á√ÉO)
================================================

app-windows.js
--------------
const WebSocket = require("ws");
const PDFDocument = require("pdfkit");
const fs = require("fs");
const bwipjs = require("bwip-js");
const { exec } = require("child_process");

const ws = new WebSocket("ws://localhost:3000");

ws.on("open", () => {
  ws.send(JSON.stringify({ type: "WINDOWS_HELLO" }));
});

ws.on("message", async msg => {
  const data = JSON.parse(msg);

  if (data.type === "PRINT_LABEL") {
    await gerarEtiqueta(data.payload);
  }
});

async function gerarEtiqueta(info) {
  const doc = new PDFDocument({ size: [300, 800] });
  doc.pipe(fs.createWriteStream("etiqueta.pdf"));

  doc.fontSize(16).text(info.produto, 20, 20);

  doc.fontSize(10)
     .text(`Peso: ${info.peso} kg`, 20, 60)
     .text(`R$/Kg: ${info.precoKg}`, 20, 80)
     .text(`TOTAL: R$ ${info.total}`, 20, 100);

  const barcode = await bwipjs.toBuffer({
    bcid: 'code128',
    text: info.barcode,
    scale: 2,
    height: 10
  });

  doc.image(barcode, 20, 140);

  doc.end();

  exec("start etiqueta.pdf");
}

================================================
10. CONFIGURA√á√ïES DE IMPRESS√ÉO
================================================

TODAS ficam no App Windows:
- Escurecimento
- DPI
- Largura do papel
- Margens
- Tipo de impressora
- Teste de impress√£o

A plataforma web N√ÉO controla hardware.

================================================
11. GARANTIA DE FUNCIONAMENTO
================================================

Se falhar:
- Web ‚Üí Windows: fila local
- Impressora: PDF fallback
- Balan√ßa: leitura manual

N√£o existe ponto √∫nico de falha.

================================================
FIM ‚Äì DOCUMENTO √öNICO PARA O REPLIT
================================================